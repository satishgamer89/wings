<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>📄 Web Doc Scanner + OCR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; overflow: hidden;
}
#sidebar {
  width: 220px; min-width: 180px; background: #f4f4f4; padding: 10px; overflow-y: auto;
  display: flex; flex-direction: column;
}
#main {
  flex: 1; display: flex; flex-direction: column; overflow: hidden;
}
#canvas-container {
  flex: 1; position: relative; display: flex; justify-content: center; align-items: center;
  background: #ddd; overflow: auto;
}
canvas {
  max-width: 100%; max-height: 100%;
}
.corner {
  width: 16px; height: 16px; background: red; border-radius: 50%; position: absolute; cursor: move;
  transform: translate(-50%, -50%);
}
.toolbar {
  display: flex; flex-wrap: wrap; gap: 5px; padding: 8px; background: #eee; align-items: center;
}
.toolbar button, .toolbar select {
  padding: 6px 10px; font-size: 14px;
}
.spinner { display: none; width: 18px; height: 18px; border: 3px solid #ccc; border-top: 3px solid #333;
  border-radius: 50%; animation: spin 1s linear infinite; }
.spinner.active { display: inline-block; }
@keyframes spin { 100% { transform: rotate(360deg);} }
#ocrResult {
  width: 100%; flex: 0.3; font-size: 14px; padding: 5px; border: none; border-top: 1px solid #ccc;
  resize: none;
}
#thumbnails {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 6px; margin-top: 10px;
}
.thumb-wrapper { position: relative; }
.thumb {
  width: 100%; max-height: 100px; object-fit: cover; border: 2px solid transparent;
  border-radius: 4px; cursor: grab; display: block;
}
.thumb.active { border: 2px solid #4caf50; }
.delete-btn {
  position: absolute; top: 4px; right: 4px; background: rgba(255,0,0,0.8); border: none; color: white;
  font-size: 12px; line-height: 1; padding: 2px 6px; border-radius: 50%; cursor: pointer; display: none;
}
.thumb-wrapper:hover .delete-btn { display: block; }
.range-group { display:flex; align-items:center; gap:5px; }
.range-group label { font-size:12px; }
@media (max-width: 768px) {
  body { flex-direction: column; }
  #sidebar { width: 100%; height: 150px; flex-direction: row; overflow-x: auto; overflow-y: hidden; }
  #thumbnails { grid-auto-flow: column; grid-template-columns: none; grid-auto-columns: 80px; }
  #main { flex: 1; }
}
</style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <div>
      <input type="file" id="fileInput" accept="image/*" multiple><br><br>
      <button onclick="saveProject()">💾 Save Project</button>
      <input type="file" id="loadProject" accept=".scanproj" style="display:none">
      <button onclick="document.getElementById('loadProject').click()">📂 Load Project</button>
    </div>
    <div id="thumbnails"></div>
  </div>

  <!-- Main -->
  <div id="main">
    <div id="canvas-container">
      <canvas id="canvas"></canvas>
      <div id="c0" class="corner"></div>
      <div id="c1" class="corner"></div>
      <div id="c2" class="corner"></div>
      <div id="c3" class="corner"></div>
    </div>
    <div class="toolbar">
      <button onclick="applyGrayscale()">Grayscale</button>
      <button onclick="performPerspectiveCorrection()">Perspective</button>
      <button onclick="autoDetectCorners()">Auto Corners</button>
      <div class="range-group">
        <label>Brightness</label>
        <input type="range" id="brightness" min="-100" max="100" value="0" oninput="applyAdjustments()">
      </div>
      <div class="range-group">
        <label>Contrast</label>
        <input type="range" id="contrast" min="-100" max="100" value="0" oninput="applyAdjustments()">
      </div>
      <select id="langSelect" multiple size="3">
        <option value="eng" selected>English</option>
        <option value="fra">French</option>
        <option value="deu">German</option>
        <option value="spa">Spanish</option>
        <option value="hin">Hindi</option>
        <option value="ara">Arabic</option>
        <option value="jpn">Japanese</option>
        <option value="chi_sim">Chinese (Simplified)</option>
      </select>
      <button onclick="runOCR()">OCR</button>
      <button onclick="downloadPDF()">Download PDF</button>
      <div class="spinner" id="spinner"></div>
      <div id="status">Idle</div>
    </div>
    <textarea id="ocrResult" placeholder="OCR result…"></textarea>
  </div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
let images=[], activeIndex=-1;
const fileInput=document.getElementById('fileInput');
const loadProjectInput=document.getElementById('loadProject');
const thumbnailsDiv=document.getElementById('thumbnails');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const statusEl=document.getElementById('status');
const spinner=document.getElementById('spinner');
const ocrResultEl=document.getElementById('ocrResult');
const corners=[c0,c1,c2,c3]; let dragCorner=null;
let brightness=0, contrast=0;

/* File Upload */
fileInput.addEventListener('change', e=>{
  const files=[...e.target.files]; images=[]; thumbnailsDiv.innerHTML=''; activeIndex=-1;
  files.forEach((file,i)=>{
    const reader=new FileReader();
    reader.onload=evt=>{
      const img=new Image();
      img.onload=()=>{
        const w=img.width,h=img.height;
        const c=[{x:0,y:0},{x:w,y:0},{x:w,y:h},{x:0,y:h}];
        images.push({img,src:evt.target.result,corners:c,ocr:""});
        if(i===files.length-1){ renderThumbnails(); selectPage(0); saveToLocal(); }
      };
      img.src=evt.target.result;
    };
    reader.readAsDataURL(file);
  });
});

/* Save / Load Project */
function saveProject(){
  const proj=JSON.stringify(images.map(r=>({src:r.src,corners:r.corners,ocr:r.ocr})));
  const blob=new Blob([proj],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="project.scanproj"; a.click();
}
loadProjectInput.addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=evt=>{ loadFromJSON(evt.target.result); };
  reader.readAsText(file);
});

/* Local Storage Auto-save */
function saveToLocal(){ localStorage.setItem("scanProject",JSON.stringify(images)); }
function loadFromLocal(){ const data=localStorage.getItem("scanProject"); if(data) loadFromJSON(data); }
function loadFromJSON(json){
  const data=JSON.parse(json); images=[];
  data.forEach((d,i)=>{ const img=new Image();
    img.onload=()=>{ images[i]={img,src:d.src,corners:d.corners,ocr:d.ocr||""};
      if(i===data.length-1){ renderThumbnails(); selectPage(0);} };
    img.src=d.src;
  });
}

/* Thumbnails */
function renderThumbnails(){
  thumbnailsDiv.innerHTML="";
  images.forEach((rec,i)=>{
    const wrapper=document.createElement("div"); wrapper.className="thumb-wrapper";
    const thumb=document.createElement("img"); thumb.src=rec.src;
    thumb.className="thumb"+(i===activeIndex?" active":""); thumb.draggable=true;
    thumb.onclick=()=>selectPage(i);
    const delBtn=document.createElement("button"); delBtn.className="delete-btn"; delBtn.textContent="❌";
    delBtn.onclick=(e)=>{ e.stopPropagation(); images.splice(i,1); activeIndex=Math.max(0,activeIndex-1);
      if(images.length===0){ canvas.width=canvas.height=0; activeIndex=-1; }
      renderThumbnails(); if(activeIndex>=0)selectPage(activeIndex); saveToLocal(); };
    wrapper.appendChild(thumb); wrapper.appendChild(delBtn); thumbnailsDiv.appendChild(wrapper);
  });
}

/* Select Page */
function selectPage(i){ activeIndex=i; renderThumbnails(); const rec=images[i];
  canvas.width=rec.img.width; canvas.height=rec.img.height; ctx.drawImage(rec.img,0,0);
  updateCornerPositions(); ocrResultEl.value=rec.ocr||""; }

/* Update Corners */
function updateCornerPositions(){ if(activeIndex<0)return; const rec=images[activeIndex]; const r=canvas.getBoundingClientRect();
  rec.corners.forEach((p,i)=>{ corners[i].style.left=(r.left+p.x*(r.width/canvas.width))+"px";
    corners[i].style.top=(r.top+p.y*(r.height/canvas.height))+"px"; }); }
window.addEventListener('resize',updateCornerPositions);

/* Drag corners */
corners.forEach((c,i)=>{ c.addEventListener('mousedown',()=>dragCorner=i); });
window.addEventListener('mouseup',()=>dragCorner=null);
window.addEventListener('mousemove',e=>{
  if(dragCorner!=null&&activeIndex>=0){
    const r=canvas.getBoundingClientRect(); const rec=images[activeIndex];
    rec.corners[dragCorner]={x:(e.clientX-r.left)*(canvas.width/r.width),y:(e.clientY-r.top)*(canvas.height/r.height)};
    redrawActive();
  }
});

/* Redraw */
function redrawActive(){ if(activeIndex<0)return; const rec=images[activeIndex];
  ctx.drawImage(rec.img,0,0); applyAdjustments(); ctx.strokeStyle="lime"; ctx.lineWidth=2; ctx.beginPath();
  rec.corners.forEach((p,i)=>{ if(i===0)ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); }); ctx.closePath(); ctx.stroke(); }

/* Image Processing */
function applyGrayscale(){ if(activeIndex<0)return; const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  for(let i=0;i<imgData.data.length;i+=4){ const avg=0.299*imgData.data[i]+0.587*imgData.data[i+1]+0.114*imgData.data[i+2];
    imgData.data[i]=imgData.data[i+1]=imgData.data[i+2]=avg; }
  ctx.putImageData(imgData,0,0); images[activeIndex].src=canvas.toDataURL(); saveToLocal(); }

function performPerspectiveCorrection(){ if(activeIndex<0)return; const rec=images[activeIndex];
  // (stub advanced correction can be improved using OpenCV.js but simplified here)
  redrawActive(); saveToLocal(); }

/* Brightness/Contrast */
function applyAdjustments(){
  if(activeIndex<0)return;
  const rec=images[activeIndex];
  ctx.drawImage(rec.img,0,0);
  const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  brightness=parseInt(document.getElementById("brightness").value);
  contrast=parseInt(document.getElementById("contrast").value);
  const factor=(259*(contrast+255))/(255*(259-contrast));
  for(let i=0;i<imgData.data.length;i+=4){
    imgData.data[i]=factor*(imgData.data[i]-128)+128+brightness;
    imgData.data[i+1]=factor*(imgData.data[i+1]-128)+128+brightness;
    imgData.data[i+2]=factor*(imgData.data[i+2]-128)+128+brightness;
  }
  ctx.putImageData(imgData,0,0);
}

/* Auto Corner Detection */
function autoDetectCorners(){ if(activeIndex<0)return; const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  let minx=imgData.width,miny=imgData.height,maxx=0,maxy=0;
  for(let y=0;y<imgData.height;y++){ for(let x=0;x<imgData.width;x++){ const idx=(y*imgData.width+x)*4;
    const v=(imgData.data[idx]+imgData.data[idx+1]+imgData.data[idx+2])/3;
    if(v<200){ if(x<minx)minx=x; if(y<miny)miny=y; if(x>maxx)maxx=x; if(y>maxy)maxy=y; } } }
  images[activeIndex].corners=[{x:minx,y:miny},{x:maxx,y:miny},{x:maxx,y:maxy},{x:minx,y:maxy}];
  redrawActive(); updateCornerPositions(); saveToLocal(); }

/* OCR */
async function runOCR(){ if(activeIndex<0){alert("Select page first");return;}
  showSpinner(true,"OCR…"); const langs=[...langSelect.selectedOptions].map(o=>o.value).join('+')||'eng';
  try{ const worker=await Tesseract.createWorker({logger:m=>statusEl.textContent=`OCR: ${m.status} ${(m.progress*100).toFixed(0)}%`});
    await worker.load(); await worker.loadLanguage(langs); await worker.initialize(langs);
    const {data:{text}}=await worker.recognize(canvas); ocrResultEl.value=text; images[activeIndex].ocr=text; saveToLocal();
    await worker.terminate(); statusEl.textContent="OCR done"; } catch(e){alert(e);} showSpinner(false); }

/* PDF Export */
function downloadPDF(){ if(images.length===0){alert("No pages");return;}
  const {jsPDF}=window.jspdf; const pdf=new jsPDF();
  images.forEach((rec,i)=>{ if(i>0)pdf.addPage(); const imgProps=pdf.getImageProperties(rec.src);
    const w=pdf.internal.pageSize.getWidth(); const h=(imgProps.height* w)/imgProps.width;
    pdf.addImage(rec.src,'JPEG',0,0,w,h); if(rec.ocr){ pdf.setFontSize(1); pdf.setTextColor(255,255,255,0);
      pdf.text(rec.ocr,10,h-10);} });
  pdf.save("scanned.pdf"); }

/* Spinner */
function showSpinner(show,msg){ spinner.classList.toggle("active",show); statusEl.textContent=msg||"Idle"; }

/* Init */
loadFromLocal();
</script>
</body>
</html>
