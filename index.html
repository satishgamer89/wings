<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Easy Billing — Firebase + PDF</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDocs, query, where, orderBy, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyALJEa8u1PdLwmOjbtfWWpBRwdNwAIvKAU",
  authDomain: "billing-database-18013.firebaseapp.com",
  databaseURL: "https://billing-database-18013-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "billing-database-18013",
  storageBucket: "billing-database-18013.firebasestorage.app",
  messagingSenderId: "108079794708",
  appId: "1:108079794708:web:3cc0c8654b1520e835b501"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM elements
const authPane = document.getElementById('authPane');
const billingPane = document.getElementById('billingPane');
const authEmail = document.getElementById('authEmail');
const authPassword = document.getElementById('authPassword');
const registerBtn = document.getElementById('registerBtn');
const loginBtn = document.getElementById('loginBtn');
const authMsg = document.getElementById('authMsg');

const clientName = document.getElementById('clientName');
const clientEmail = document.getElementById('clientEmail');
const clientPhone = document.getElementById('clientPhone');
const dueDate = document.getElementById('dueDate');
const addItemBtn = document.getElementById('addItemBtn');
const clearItemsBtn = document.getElementById('clearItemsBtn');
const itemsContainer = document.getElementById('itemsContainer');
const taxInput = document.getElementById('taxInput');
const currencySelect = document.getElementById('currencySelect');
const generateBtn = document.getElementById('generateBtn');
const recordsBody = document.getElementById('recordsBody');

// Modal elements
const modalBackdrop = document.getElementById('modalBackdrop');
const modalInvId = document.getElementById('modalInvId');
const modalClient = document.getElementById('modalClient');
const modalDate = document.getElementById('modalDate');
const modalItemsBody = document.getElementById('modalItemsBody');
const modalSubtotal = document.getElementById('modalSubtotal');
const modalTax = document.getElementById('modalTax');
const modalTotal = document.getElementById('modalTotal');
const printBtn = document.getElementById('printBtn');
const downloadBtn = document.getElementById('downloadBtn');
const closeModalBtn = document.getElementById('closeModalBtn');

// --- Auth ---
registerBtn.addEventListener('click', async () => {
  try {
    await createUserWithEmailAndPassword(auth, authEmail.value, authPassword.value);
    authMsg.style.color = 'green';
    authMsg.textContent = 'Registered! Logging in...';
  } catch(err){
    authMsg.style.color = 'red';
    authMsg.textContent = err.message;
  }
});

loginBtn.addEventListener('click', async () => {
  try{
    await signInWithEmailAndPassword(auth, authEmail.value, authPassword.value);
    authMsg.style.color = 'green';
    authMsg.textContent = 'Logged in!';
  } catch(err){
    authMsg.style.color = 'red';
    authMsg.textContent = err.message;
  }
});

onAuthStateChanged(auth, user => {
  if(user){
    billingPane.style.display='block';
    authPane.style.display='none';
    loadUserInvoices(user.uid);
  } else {
    billingPane.style.display='none';
    authPane.style.display='block';
  }
});

// --- Item Management ---
function addItem(desc='', qty=1, price=0){
  const row=document.createElement('div'); row.className='item-row';
  row.innerHTML=`<input class="desc" placeholder="Description" value="${desc}">
    <input class="qty" type="number" min="1" value="${qty}">
    <input class="price" type="number" min="0" step="0.01" value="${price}">
    <button class="remove">✕</button>`;
  row.querySelector('.remove').onclick=()=>row.remove();
  itemsContainer.appendChild(row);
}
clearItemsBtn.onclick=()=>{ itemsContainer.innerHTML=''; addItem(); }
addItemBtn.onclick=()=>addItem();
addItem(); // initial row

// --- Generate Invoice ---
generateBtn.onclick = async () => {
  const user = auth.currentUser; if(!user){ alert('Login first'); return; }
  const items = Array.from(itemsContainer.querySelectorAll('.item-row')).map(r=>({
    desc: r.querySelector('.desc').value,
    qty: parseFloat(r.querySelector('.qty').value),
    price: parseFloat(r.querySelector('.price').value)
  })).filter(i=>i.desc && i.qty>0);
  if(items.length===0){ alert('Add items'); return; }
  const subtotal = items.reduce((a,b)=>a+b.qty*b.price,0);
  const taxPct = parseFloat(taxInput.value)||0;
  const taxAmount = subtotal*taxPct/100;
  const total = subtotal+taxAmount;
  const invId = 'INV-'+Date.now();

  await setDoc(doc(db,'invoices',invId),{
    userId: user.uid,
    clientName: clientName.value,
    clientEmail: clientEmail.value,
    clientPhone: clientPhone.value,
    dueDate: dueDate.value,
    items,
    subtotal,
    taxPct,
    taxAmount,
    total,
    currency: currencySelect.value,
    date: (new Date()).toISOString().split('T')[0]
  });

  itemsContainer.innerHTML=''; addItem();
  loadUserInvoices(user.uid);
}

// --- Load invoices ---
async function loadUserInvoices(uid){
  const q = query(collection(db,'invoices'), where('userId','==',uid), orderBy('date','desc'));
  const snapshot = await getDocs(q);
  recordsBody.innerHTML='';
  snapshot.forEach(docItem=>{
    const inv = docItem.data();
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${docItem.id}</td><td>${inv.clientName}</td><td>${inv.date}</td><td style="text-align:right">${inv.currency} ${inv.total.toFixed(2)}</td>
      <td>
        <button onclick="viewInvoice('${docItem.id}')">View</button>
        <button onclick="deleteInvoice('${docItem.id}')">Delete</button>
      </td>`;
    recordsBody.appendChild(tr);
  });
}

// --- View Modal ---
window.viewInvoice = async (id) => {
  const docRef = doc(db,'invoices',id);
  const docSnap = await getDoc(docRef);
  if(!docSnap.exists()){ alert('Invoice not found'); return; }
  const inv = docSnap.data();
  modalInvId.textContent = id;
  modalClient.textContent = inv.clientName;
  modalDate.textContent = inv.date;

  modalItemsBody.innerHTML='';
  inv.items.forEach(it=>{
    const r = document.createElement('tr');
    r.innerHTML=`<td>${it.desc}</td><td>${it.qty}</td><td>${inv.currency} ${it.price.toFixed(2)}</td><td>${inv.currency} ${(it.qty*it.price).toFixed(2)}</td>`;
    modalItemsBody.appendChild(r);
  });

  modalSubtotal.textContent = inv.currency+' '+inv.subtotal.toFixed(2);
  modalTax.textContent = inv.currency+' '+inv.taxAmount.toFixed(2);
  modalTotal.textContent = inv.currency+' '+inv.total.toFixed(2);

  modalBackdrop.style.display='flex';
}

// --- Delete Invoice ---
window.deleteInvoice = async (id) => {
  if(confirm('Delete invoice '+id+'?')){
    await deleteDoc(doc(db,'invoices',id));
    loadUserInvoices(auth.currentUser.uid);
    if(modalBackdrop.style.display==='flex' && modalInvId.textContent===id){
      modalBackdrop.style.display='none';
    }
  }
}

// --- Modal Print / Download PDF ---
printBtn.onclick = () => {
  const element = document.getElementById('modalContent');
  html2pdf().from(element).set({margin:10,jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}).toPdf().get('pdf').then(pdf=>{pdf.autoPrint(); window.open(pdf.output('bloburl'),'_blank');});
}

downloadBtn.onclick = () => {
  const element = document.getElementById('modalContent');
  html2pdf().from(element).set({margin:10,filename:'invoice-'+modalInvId.textContent+'.pdf',jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}).save();
}

closeModalBtn.onclick = () => { modalBackdrop.style.display='none'; }

</script>

<style>
body{font-family:Inter,sans-serif;margin:24px;background:#f4f7fb;color:#0f172a;}
.card{background:#fff;padding:18px;margin-bottom:16px;border-radius:12px;box-shadow:0 8px 24px rgba(15,23,42,0.04);}
input, select{width:100%;padding:10px;margin-top:6px;border-radius:10px;border:1px solid #e6e9ef;}
button{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;background:#3b82f6;color:#fff;margin-top:6px;}
button.ghost{background:transparent;border:1px solid #e6e9ef;color:#3b82f6;}
.row{display:flex;gap:10px;align-items:center;margin-top:10px;}
.item-row{display:flex;gap:8px;margin-top:8px;align-items:center;}
.desc{flex:1;} .qty{width:80px;} .price{width:110px;} .remove{background:transparent;color:#ef4444;font-size:20px;border:none;cursor:pointer;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border-bottom:1px solid #f0f2f5;text-align:left;font-size:14px;}

.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px;}
.modal{background:#fff;border-radius:12px;padding:18px;width:100%;max-width:600px;max-height:90vh;overflow:auto;}
.modal table{width:100%;border-collapse:collapse;margin-top:12px;}
.modal th, .modal td{border:1px solid #ddd;padding:8px;text-align:left;}
.modal-header{display:flex;justify-content:space-between;align-items:center;}
</style>
</head>
<body>

<div class="card" id="authPane">
  <h3>Register / Login</h3>
  <input id="authEmail" type="email" placeholder="Email">
  <input id="authPassword" type="password" placeholder="Password">
  <div class="row">
    <button id="registerBtn">Register</button>
    <button id="loginBtn" class="ghost">Login</button>
  </div>
  <div id="authMsg" style="margin-top:6px;"></div>
</div>

<div id="billingPane" style="display:none;">
  <div class="card">
    <h3>Client Info</h3>
    <input id="clientName" placeholder="Client Name">
    <input id="clientEmail" placeholder="Client Email">
    <input id="clientPhone" placeholder="Client Phone">
    <input id="dueDate" type="date">
  </div>
  <div class="card">
    <h3>Items</h3>
    <div id="itemsContainer"></div>
    <div class="row">
      <button id="addItemBtn">+ Add Item</button>
      <button id="clearItemsBtn" class="ghost">Clear</button>
    </div>
  </div>
  <div class="card">
    <input id="taxInput" type="number" placeholder="Tax %">
    <select id="currencySelect">
      <option value="₹">INR</option>
      <option value="$">USD</option>
    </select>
    <button id="generateBtn">Generate & Save Invoice</button>
  </div>
  <div class="card">
    <h3>Invoice Records</h3>
    <table>
      <thead><tr><th>ID</th><th>Client</th><th>Date</th><th>Total</th><th></th></tr></thead>
      <tbody id="recordsBody"></tbody>
    </table>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" id="modalContent">
    <div class="modal-header">
      <div><strong>Invoice:</strong> <span id="modalInvId"></span><br>
        <strong>Client:</strong> <span id="modalClient"></span><br>
        <strong>Date:</strong> <span id="modalDate"></span>
      </div>
      <div>
        <button id="printBtn">Print</button>
        <button id="downloadBtn">Download PDF</button>
        <button id="closeModalBtn" class="ghost">Close</button>
      </div>
    </div>
    <table>
      <thead><tr><th>Description</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
      <tbody id="modalItemsBody"></tbody>
    </table>
    <div style="margin-top:12px;text-align:right;">
      Subtotal: <span id="modalSubtotal"></span><br>
      Tax: <span id="modalTax"></span><br>
      <strong>Total: <span id="modalTotal"></span></strong>
    </div>
  </div>
</div>

</body>
</html>
